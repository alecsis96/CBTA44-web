<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Acceso al Portal de Gesti√≥n - CBTA #44">
    <title>Portal de Gesti√≥n - CBTA #44</title>

    <link rel="stylesheet" href="../css/main.css">
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg">

    <style>
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2A7AE2 0%, #2EA08B 100%);
            padding: var(--spacing-lg);
        }

        .login-container {
            max-width: 450px;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            padding: var(--spacing-2xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin-bottom: var(--spacing-md);
        }

        /* TABS */
        .auth-tabs {
            display: flex;
            margin-bottom: var(--spacing-xl);
            border-bottom: 2px solid var(--color-gray-200);
        }

        .auth-tab {
            flex: 1;
            padding: var(--spacing-md);
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-gray-500);
            transition: all var(--transition-base);
            background: none;
            border: none;
            font-size: 1rem;
        }

        .auth-tab.active {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            margin-bottom: -2px;
        }

        .auth-tab:hover:not(.active) {
            color: var(--color-gray-700);
            background-color: var(--color-gray-50);
        }

        /* FORMS */
        .auth-form {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: border-color var(--transition-base);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(42, 122, 226, 0.1);
        }

        .form-select {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background-color: white;
        }

        .btn-submit {
            width: 100%;
            padding: var(--spacing-md);
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color var(--transition-base);
            margin-top: var(--spacing-md);
        }

        .btn-submit:hover {
            background-color: var(--color-primary-dark);
        }

        .btn-submit:disabled {
            background-color: var(--color-gray-400);
            cursor: not-allowed;
        }

        .dev-mode {
            margin-top: var(--spacing-2xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--color-gray-200);
            text-align: center;
        }

        .dev-toggle {
            background: none;
            border: none;
            color: var(--color-gray-400);
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
        }

        .quick-access-panel {
            display: none;
            margin-top: var(--spacing-lg);
            background: var(--color-gray-50);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
        }

        .quick-access-panel.visible {
            display: block;
        }

        .quick-btn-mini {
            display: block;
            width: 100%;
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            background: white;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: left;
            font-size: 0.9rem;
        }

        .quick-btn-mini:hover {
            background: var(--color-gray-100);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="login-page">
        <div class="login-container">
            <div class="login-header">
                <img src="../assets/images/logo.svg" alt="CBTA #44" class="login-logo">
                <h2>Portal CBTA #44</h2>
                <p class="text-gray">Gesti√≥n Escolar Integral</p>
            </div>

            <!-- TABS -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">Iniciar Sesi√≥n</button>
                <button class="auth-tab" onclick="switchTab('register')">Registrarse</button>
            </div>

            <!-- LOGIN FORM -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Correo Electr√≥nico</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="ejemplo@cbta44.edu.mx" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-submit" id="loginBtn">
                    Ingresar
                </button>
            </form>

            <!-- REGISTER FORM -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" id="regName" class="form-input" placeholder="Juan P√©rez" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Correo Electr√≥nico</label>
                    <input type="email" id="regEmail" class="form-input" placeholder="juan@cbta44.edu.mx" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="regPassword" class="form-input" placeholder="M√≠nimo 6 caracteres"
                        minlength="6" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Usuario</label>
                    <select id="regRole" class="form-select" required>
                        <option value="" disabled selected>Selecciona tu rol</option>
                        <option value="alumno">Alumno</option>
                        <option value="docente">Docente</option>
                    </select>
                </div>
                <button type="submit" class="btn-submit" id="regBtn">
                    Crear Cuenta
                </button>
            </form>

            <div style="text-align: center; margin-top: var(--spacing-xl);">
                <a href="../index.html" class="text-primary" style="text-decoration: none; font-size: 0.9rem;">
                    ‚Üê Volver al Sitio P√∫blico
                </a>
            </div>

            <!-- DEV MODE TOGGLE -->
            <div class="dev-mode">
                <button class="dev-toggle" onclick="toggleDevMode()">Modo Desarrollador (Acceso R√°pido)</button>
                <div id="devPanel" class="quick-access-panel">
                    <button class="quick-btn-mini" onclick="quickLogin('admin')">üîë Admin (admin@cbta44.edu.mx)</button>
                    <button class="quick-btn-mini" onclick="quickLogin('docente')">üë®‚Äçüè´ Docente
                        (docente@cbta44.edu.mx)</button>
                    <button class="quick-btn-mini" onclick="quickLogin('alumno')">üéì Alumno
                        (alumno@cbta44.edu.mx)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>

    <!-- Scripts de la aplicaci√≥n -->
    <script src="../js/main.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        // Login Handler
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            setLoading(btn, true, 'Ingresando...');

            try {
                // Usamos el m√©todo login gen√©rico de authManager
                // Nota: login ahora detectar√° el rol autom√°ticamente desde el perfil
                await authManager.loginWithEmail(email, password);

                // Redirecci√≥n manejada por authManager
                authManager.redirectToDashboard();

            } catch (error) {
                console.error(error);
                alert('Error: ' + error.message);
                setLoading(btn, false, 'Ingresar');
            }
        }

        // Register Handler
        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('regBtn');

            const userData = {
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                role: document.getElementById('regRole').value
            };

            setLoading(btn, true, 'Creando cuenta...');

            try {
                await authManager.register(userData);

                alert('¬°Cuenta creada exitosamente! Bienvenido.');
                authManager.redirectToDashboard();

            } catch (error) {
                console.error(error);
                alert('Error: ' + error.message);
                setLoading(btn, false, 'Crear Cuenta');
            }
        }

        // Helper: Loading State
        function setLoading(btn, isLoading, text) {
            btn.disabled = isLoading;
            btn.textContent = text;
        }

        // Dev Mode
        function toggleDevMode() {
            document.getElementById('devPanel').classList.toggle('visible');
        }

        // Quick Login (Legacy Support for Dev Mode)
        async function quickLogin(role) {
            const credentials = {
                'admin': { email: 'admin@cbta44.edu.mx', password: 'Admin123!' },
                'docente': { email: 'docente@cbta44.edu.mx', password: 'Docente123!' },
                'alumno': { email: 'alumno@cbta44.edu.mx', password: 'Alumno123!' },
            };

            const cred = credentials[role];
            if (!cred) return;

            try {
                await authManager.loginWithEmail(cred.email, cred.password);
                authManager.redirectToDashboard();
            } catch (error) {
                alert('Error en acceso r√°pido: ' + error.message);
            }
        }
    </script>
</body>

</html>